#!/bin/bash

# Bitcoin Trading Bot - Unified Control Script
# Usage: ./bot [command]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIVE_DIR="$SCRIPT_DIR/live_trading"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘${NC}  $1"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Commands
cmd_help() {
    cat << EOF
ğŸ¤– Bitcoin Trading Bot - Control Script

USAGE:
    ./bot [command]

COMMANDS:
    setup              Ä°lk kurulum (dependencies + model eÄŸitimi)
    train              Model eÄŸitimi (7 yÄ±llÄ±k data)

    testnet            Testnet bot baÅŸlat (sahte para)
    production         Production bot baÅŸlat (gerÃ§ek para) âš ï¸

    dashboard          Metrics dashboard baÅŸlat (port 8501)
    chart              Chart dashboard baÅŸlat (port 8502)
    dashboards         Her iki dashboard'u baÅŸlat

    test               Binance API baÄŸlantÄ±sÄ±nÄ± test et
    backtest           Backtest Ã§alÄ±ÅŸtÄ±r (walk-forward)

    stop               TÃ¼m Ã§alÄ±ÅŸan botlarÄ± ve dashboard'larÄ± durdur
    status             Ã‡alÄ±ÅŸan servisleri gÃ¶ster
    logs               Bot loglarÄ±nÄ± gÃ¶ster

    help               Bu yardÄ±m mesajÄ±nÄ± gÃ¶ster

EXAMPLES:
    # Ä°lk kurulum
    ./bot setup

    # Testnet'te baÅŸla
    ./bot testnet

    # Dashboard'larÄ± aÃ§
    ./bot dashboards

    # Production (dikkatli!)
    ./bot production

QUICK START:
    1. ./bot setup          # Kurulum (10-30 dakika)
    2. ./bot testnet        # Bot baÅŸlat (testnet)
    3. ./bot dashboards     # Dashboard'larÄ± aÃ§ (yeni terminal)
    4. Browser: http://localhost:8501 ve :8502
EOF
}

cmd_setup() {
    print_header "ğŸš€ Ä°lk Kurulum BaÅŸlÄ±yor"

    # Check Python
    if ! command -v python3 &> /dev/null; then
        print_error "Python 3 bulunamadÄ±. Ã–nce Python 3.8+ yÃ¼kleyin."
        exit 1
    fi

    print_info "Python versiyonu: $(python3 --version)"

    # Install dependencies
    print_info "Dependencies yÃ¼kleniyor..."
    pip install -r "$SCRIPT_DIR/requirements.txt" || {
        print_error "Dependencies yÃ¼klenemedi"
        exit 1
    }
    print_success "Dependencies yÃ¼klendi"

    # Create .env if not exists
    if [ ! -f "$LIVE_DIR/.env" ]; then
        print_info ".env dosyasÄ± oluÅŸturuluyor..."
        cp "$LIVE_DIR/.env.example" "$LIVE_DIR/.env"
        print_warning ".env dosyasÄ±na API keylerini eklemeyi unutma!"
        print_info "Testnet keyleri: https://testnet.binancefuture.com/"
    fi

    # Train model
    print_info "Model eÄŸitimi baÅŸlÄ±yor (10-30 dakika)..."
    cmd_train

    print_success "Kurulum tamamlandÄ±!"
    echo ""
    print_info "Sonraki adÄ±mlar:"
    echo "  1. .env dosyasÄ±na testnet API keylerini ekle: nano live_trading/.env"
    echo "  2. Botu baÅŸlat: ./bot testnet"
    echo "  3. Dashboard'larÄ± aÃ§: ./bot dashboards"
}

cmd_train() {
    print_header "ğŸ§  Model EÄŸitimi (7 YÄ±llÄ±k Data)"

    cd "$SCRIPT_DIR"

    if [ ! -f "btc_15m_data_2018_to_2025.csv" ]; then
        print_error "btc_15m_data_2018_to_2025.csv bulunamadÄ±!"
        exit 1
    fi

    print_info "EÄŸitim baÅŸlÄ±yor... (bu biraz sÃ¼rebilir)"

    python3 << 'PYTHON_SCRIPT'
import sys
import yaml
import pickle
from src.data.data_loader import DataLoader
from src.features.feature_engineering import FeatureEngineering
from src.advanced.integrated_system import IntegratedTradingSystem

print("ğŸ“Š Data yÃ¼kleniyor...")
with open('config.yaml', 'r') as f:
    config = yaml.safe_load(f)

loader = DataLoader(config)
data = loader.load_data()
print(f"âœ… {len(data)} candle yÃ¼klendi")

print("ğŸ”§ Feature engineering...")
fe = FeatureEngineering(config)
multi_tf_data = fe.create_multi_timeframe_features(data)
features, target = fe.prepare_ml_dataset(multi_tf_data)
print(f"âœ… {len(features.columns)} feature oluÅŸturuldu")

print("ğŸ¤– Model eÄŸitiliyor...")
system = IntegratedTradingSystem(config)
system.train(features, target)
print("âœ… Model eÄŸitildi")

print("ğŸ’¾ Model kaydediliyor...")
import os
os.makedirs('models', exist_ok=True)
with open('models/advanced_system_latest.pkl', 'wb') as f:
    pickle.dump(system, f)
print("âœ… Model kaydedildi: models/advanced_system_latest.pkl")
PYTHON_SCRIPT

    if [ $? -eq 0 ]; then
        print_success "Model eÄŸitimi tamamlandÄ±!"
    else
        print_error "Model eÄŸitimi baÅŸarÄ±sÄ±z oldu"
        exit 1
    fi
}

cmd_testnet() {
    print_header "ğŸ§ª Testnet Bot BaÅŸlatÄ±lÄ±yor"

    # Check .env
    if [ ! -f "$LIVE_DIR/.env" ]; then
        print_error ".env dosyasÄ± bulunamadÄ±!"
        print_info "Ã–nce kurulum yapÄ±n: ./bot setup"
        exit 1
    fi

    # Check model
    if [ ! -f "$SCRIPT_DIR/models/advanced_system_latest.pkl" ]; then
        print_error "Model bulunamadÄ±!"
        print_info "Ã–nce model eÄŸitin: ./bot train"
        exit 1
    fi

    # Check config
    if ! grep -q "testnet: true" "$LIVE_DIR/config_live.yaml"; then
        print_warning "config_live.yaml'da testnet: false gÃ¶rÃ¼nÃ¼yor"
        print_warning "Testnet iÃ§in testnet: true olmalÄ±"
    fi

    print_success "Testnet bot baÅŸlÄ±yor..."
    print_info "Ctrl+C ile durdurun"
    print_info "Dashboard: ./bot dashboards (baÅŸka terminalde)"
    echo ""

    cd "$LIVE_DIR"
    python3 live_trader.py
}

cmd_production() {
    print_header "âš ï¸  PRODUCTION BOT - GERÃ‡EK PARA!"

    echo ""
    print_warning "GERÃ‡EK PARA Ä°LE TRADING YAPACAKSINIZ!"
    print_warning "TÃ¼m riski kabul ediyor musunuz?"
    echo ""
    print_info "Production checklist:"
    echo "  âœ“ Testnet'te en az 1 hafta test ettiniz"
    echo "  âœ“ API key IP whitelist eklendi"
    echo "  âœ“ 2FA aktif"
    echo "  âœ“ Withdrawal izni KAPALI"
    echo "  âœ“ .env.production dosyasÄ± hazÄ±r"
    echo "  âœ“ config_production.yaml kontrol edildi"
    echo ""

    read -p "Production baÅŸlatmak iÃ§in 'START PRODUCTION' yazÄ±n: " confirm

    if [ "$confirm" != "START PRODUCTION" ]; then
        print_info "Ä°ptal edildi. GÃ¼vende kaldÄ±nÄ±z!"
        exit 0
    fi

    # Check .env.production
    if [ ! -f "$LIVE_DIR/.env.production" ]; then
        print_error ".env.production bulunamadÄ±!"
        print_info "Ã–nce .env.production oluÅŸturun"
        exit 1
    fi

    # Check model
    if [ ! -f "$SCRIPT_DIR/models/advanced_system_latest.pkl" ]; then
        print_error "Model bulunamadÄ±!"
        exit 1
    fi

    print_success "Production bot baÅŸlÄ±yor..."
    print_warning "DÄ°KKATLÄ° OLUN!"
    echo ""

    cd "$LIVE_DIR"
    ENV_FILE=.env.production python3 live_trader.py --config config_production.yaml
}

cmd_dashboard() {
    print_header "ğŸ“Š Metrics Dashboard BaÅŸlatÄ±lÄ±yor"

    print_info "Port: 8501"
    print_info "URL: http://localhost:8501"
    print_info "Ctrl+C ile durdurun"
    echo ""

    cd "$LIVE_DIR"
    streamlit run dashboard.py --server.port 8501
}

cmd_chart() {
    print_header "ğŸ“ˆ Chart Dashboard BaÅŸlatÄ±lÄ±yor"

    print_info "Port: 8502"
    print_info "URL: http://localhost:8502"
    print_info "Ctrl+C ile durdurun"
    echo ""

    cd "$LIVE_DIR"
    streamlit run chart_dashboard.py --server.port 8502
}

cmd_dashboards() {
    print_header "ğŸ“Š Her Ä°ki Dashboard BaÅŸlatÄ±lÄ±yor"

    print_info "Terminal 1: Metrics Dashboard (port 8501)"
    print_info "Terminal 2: Chart Dashboard (port 8502)"
    echo ""
    print_warning "Her dashboard iÃ§in AYRI terminal aÃ§Ä±n:"
    echo ""
    echo "  Terminal 1: ./bot dashboard"
    echo "  Terminal 2: ./bot chart"
    echo ""
    print_info "Ya da arka planda baÅŸlat:"
    echo "  ./bot dashboard > /dev/null 2>&1 &"
    echo "  ./bot chart > /dev/null 2>&1 &"
}

cmd_test() {
    print_header "ğŸ”Œ API BaÄŸlantÄ± Testi"

    if [ ! -f "$LIVE_DIR/.env" ]; then
        print_error ".env dosyasÄ± bulunamadÄ±!"
        exit 1
    fi

    cd "$LIVE_DIR"
    python3 test_connection.py
}

cmd_backtest() {
    print_header "ğŸ“Š Backtest (Walk-Forward Analysis)"

    cd "$SCRIPT_DIR"
    python3 run_walk_forward.py
}

cmd_stop() {
    print_header "ğŸ›‘ Servisleri Durduruyor"

    # Stop Python processes
    print_info "Bot ve dashboard'larÄ± durduruyor..."
    pkill -f "live_trader.py" || true
    pkill -f "streamlit" || true

    print_success "TÃ¼m servisler durduruldu"
}

cmd_status() {
    print_header "ğŸ“Š Servis Durumu"

    echo ""
    print_info "Ã‡alÄ±ÅŸan Python processler:"
    pgrep -af "live_trader.py" || echo "  Bot Ã§alÄ±ÅŸmÄ±yor"
    pgrep -af "streamlit.*dashboard" || echo "  Dashboard Ã§alÄ±ÅŸmÄ±yor"
    pgrep -af "streamlit.*chart" || echo "  Chart dashboard Ã§alÄ±ÅŸmÄ±yor"
    echo ""
}

cmd_logs() {
    print_header "ğŸ“œ Bot LoglarÄ±"

    if [ -f "$LIVE_DIR/logs/live_trader.log" ]; then
        tail -f "$LIVE_DIR/logs/live_trader.log"
    else
        print_warning "Log dosyasÄ± bulunamadÄ±"
        print_info "Bot Ã§alÄ±ÅŸmaya baÅŸladÄ±ktan sonra loglar gÃ¶rÃ¼necek"
    fi
}

# Main
case "${1:-help}" in
    setup)
        cmd_setup
        ;;
    train)
        cmd_train
        ;;
    testnet)
        cmd_testnet
        ;;
    production)
        cmd_production
        ;;
    dashboard)
        cmd_dashboard
        ;;
    chart)
        cmd_chart
        ;;
    dashboards)
        cmd_dashboards
        ;;
    test)
        cmd_test
        ;;
    backtest)
        cmd_backtest
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    logs)
        cmd_logs
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        print_error "Bilinmeyen komut: $1"
        echo ""
        cmd_help
        exit 1
        ;;
esac
